#define _CRT_SECURE_NO_WARNINGS
#include <windows.h>
#include <stdio.h>
#include <detours.h>

int RunDetoured(int argc, char **argv)
{
	CHAR	*pMonitorPath	= argv[1];
	CHAR	*pTargetPath	= argv[2];
	CHAR	**ppArgs		= &argv[3];

	STARTUPINFOA			si;
	PROCESS_INFORMATION		pi;
	BOOL					bRet;

	static CHAR				szCmdLine[4096];

	_snprintf(szCmdLine, sizeof(szCmdLine) - 1, "\"%s\"", pTargetPath);

	for(int i = 3; i < 3; i++) {
		strcat(szCmdLine, " ");
		strcat(szCmdLine, ppArgs[i]);
	}

	ZeroMemory((void*) &si, sizeof(si));
	ZeroMemory((void*) &pi, sizeof(pi));
	
	si.cb = sizeof(si);

	printf("[+] Monitor Path: %s\n", pMonitorPath);
	printf("[+] Command Line: %s\n", szCmdLine);

	bRet = DetourCreateProcessWithDllA(NULL, szCmdLine, NULL, NULL, FALSE, 0, NULL, NULL, &si, &pi, pMonitorPath, NULL);
	if(!bRet)
		printf("[-] Error: %d\n", GetLastError());
	else
		printf("[+] Success");

	return (bRet ? 0 : 1);
}

int Usage()
{
	printf("Usage: \n");
	printf("\tHiLoader.exe [Monitor-DLL-Path] [Targt-Exe] [Command-Line-Args]\n");

	return 1;
}

int main(int argc, char **argv)
{
	if(argc < 3)
		return Usage();

	return RunDetoured(argc, argv);
}